pipeline {
  agent any

  options { timestamps() }

  parameters {
    booleanParam(name: 'USE_MOCK', defaultValue: true,
                 description: 'Run mock lint & security instead of real tools')
  }

  environment {
    // IDs כפי שהגדרת ב-Credentials (Username/Password)
    DOCKERHUB = credentials('dockerhub')
    // נבנה פעם אחת ונשתמש בכל השלבים
    IMAGE      = "${DOCKERHUB_USR}/smart-link-app"
    IMAGE_TAG  = "${env.BUILD_NUMBER}"
    IMAGE_FULL = "${IMAGE}:${IMAGE_TAG}"
    IMAGE_LATEST = "${IMAGE}:latest"
  }

  stages {

    stage('Checkout') {
      steps { checkout scm }
    }

    stage('Parallel Checks') {
      parallel {
        stage('Linting') {
          steps {
            script {
              if (params.USE_MOCK) {
                sh '''
                  echo "[MOCK] flake8 ."
                  echo "[MOCK] shellcheck **/*.sh"
                  echo "[MOCK] hadolint Dockerfile"
                '''
              } else {
                sh '''
                  python3 -m pip install --upgrade pip >/dev/null 2>&1 || true
                  pip3 install flake8 bandit >/dev/null 2>&1 || true
                  if ! command -v hadolint >/dev/null 2>&1; then
                    curl -sL https://github.com/hadolint/hadolint/releases/latest/download/hadolint-Linux-x86_64 -o /usr/local/bin/hadolint
                    chmod +x /usr/local/bin/hadolint
                  fi
                  flake8 .
                  if ls *.sh >/dev/null 2>&1; then shellcheck *.sh; fi
                  hadolint Dockerfile
                '''
              }
            }
          }
        }

        stage('Security Scan (Code)') {
          steps {
            script {
              if (params.USE_MOCK) {
                sh """
                  echo "[MOCK] bandit -r ."
                  echo "[MOCK] trivy image ${IMAGE_FULL}"
                """
              } else {
                sh '''
                  python3 -m pip install bandit >/dev/null 2>&1 || true
                  bandit -q -r .
                  if ! command -v trivy >/dev/null 2>&1; then
                    sudo rpm -Uvh --quiet https://github.com/aquasecurity/trivy/releases/latest/download/trivy_0.55.0_Linux-64bit.rpm || true
                  fi
                  echo "Trivy will scan after build stage on the built image"
                '''
              }
            }
          }
        }
      }
    }

    stage('Docker Build & Login') {
      steps {
        withCredentials([usernamePassword(credentialsId: 'dockerhub',
                        usernameVariable: 'DH_USER', passwordVariable: 'DH_PASS')]) {
          sh """
            echo "\$DH_PASS" | docker login -u "\$DH_USER" --password-stdin
            docker build -t "${IMAGE_FULL}" -t "${IMAGE_LATEST}" .
          """
        }
      }
    }

    stage('Security Scan (Image)') {
      when { expression { return !params.USE_MOCK } }
      steps {
        sh """
          trivy image --exit-code 0 --severity LOW,MEDIUM "${IMAGE_FULL}"
          trivy image --exit-code 1 --severity HIGH,CRITICAL "${IMAGE_FULL}" || {
            echo "High/Critical vulnerabilities found"; exit 1;
          }
        """
      }
    }

    stage('Push to Docker Hub') {
      steps {
        withCredentials([usernamePassword(credentialsId: 'dockerhub',
                        usernameVariable: 'DH_USER', passwordVariable: 'DH_PASS')]) {
          sh """
            echo "\$DH_PASS" | docker login -u "\$DH_USER" --password-stdin
            docker push "${IMAGE_FULL}"
            docker push "${IMAGE_LATEST}"
          """
        }
      }
    }
  }
post {
    always {
      script {
        sh 'docker logout || true'
      }
    }
    success {
      echo "Done. Image: ${IMAGE_FULL}"
    }
    failure {
      echo 'Pipeline failed. Check above logs.'
    }
  }
}
  
